name: Dev-Build-Pipeline
## Notes:
# A sample z/OS DBB workflow using GitHub Actions (GHA) with SSH connection
# Global vars
env:
  # SSH connection information
  DBB_Host: '"C:\Program Files\PuTTY\plink.exe" DMJTA1@WTSC47.CPOLAB.IBM.COM -pw ${{ secrets.WTSC47_PW }}' # A valid SSH account on Z. With pre-generated and tested keys in the runner.
  # Pipeline scripts on z/OS (relative to the SSH user's Home Dir in USS)
  Clone: '/u/DMJTA1/GitHubWS/scripts/git-clone-ssh.sh' # Script to clone the code from GitHub to z/OS
  DBB_Build: '/u/DMJTA1/GitHubWS/scripts/dbb-build.sh' # Script to perform the DBB build on z/OS
  UCD_Package: '/u/DMJTA1/GitHubWS/scripts/PublishUCD.sh' # Script to perform the DBB build on z/OS
  UCD_Deploy: '/u/DMJTA1/GitHubWS/scripts/DeployUCD.sh' # Script to perform the DBB build on z/OS
# "on" trigger to manually start this workflow. Can add "pull, push..." for auto trigger.
# see https://docs.github.com/en/actions/learn-github-actions/contexts
#on: 
#    push:
 #      branches:
  #      - '**ZUNIT**'
   #     - '**TEST**'
    #    - '**ZPROJ**'
     #  paths:
      #  - '**.cbl'
       # - '**.cpy'
on: workflow_dispatch
      
jobs:
  DBB_Build_on_zOS:
    runs-on: self-hosted
    env:
        # Project related variables. GHA automatically fills in relevant repository information for values enclosed in ${{ ... }}.
        MyRepo: git@github.com:${{ github.repository }}.git # Source code repository URL (SSH)
        MyBranch: ${{ github.ref }} # Branch on which to run the GHA pipeline
        MyWorkDir: /u/DMJTA1/GitHubWS/Genapp_run_${{ github.run_number }} # Absolute path to directory for storing the clone and build outputs
        MyWorkSpace: /u/DMJTA1/GitHubWS/Genapp_run_${{ github.run_number }}/GenappML2  # Absolute path to workspace (root) directory containing all required source directories
        MyApplication: cics-genapp # Application directory name (relative to MyWorkSpace)
        MyHlq: DMJTA1 # High level qualifier for partitioned data sets created during the build
    steps:
        - name: Clone repository
          run: ${{ env.DBB_Host }} ${{ env.Clone }} ${{ env.MyRepo }} ${{ env.MyWorkDir }} ${{ env.MyWorkSpace }} ${{ env.MyBranch }}
          shell: cmd 
          
        - name: Collect Feature Branch name for Build Datasets
          uses: bhowell2/github-substring-action@v1.0.0
          id: one
          with:
            value: "${{ github.ref }}"
            index_of_str: "refs/heads/"
            length_from_start: 8
            
        - name: Remove - and / from HLQ
          uses: mad9000/actions-find-and-replace-string@2
          id: removedChars
          with:
            source: ${{ steps.one.outputs.substring }}
            find: '-'        
            replace: ''

        - name: DBB Impact Build
          run: ${{ env.DBB_Host }} ${{ env.DBB_Build }} ${{ env.MyWorkDir }} ${{ env.MyWorkSpace }} ${{ env.MyApplication }} DMJTA1.${{ steps.removedChars.outputs.value }} --impactBuild 
          shell: cmd 
          
        - name: Package
          run: ${{ env.DBB_Host }} ${{ env.UCD_Package }} ${{ env.MyBranch }}.${{ github.run_number }}  GeneralsBackendComponent ${{ env.MyWorkDir }}
          shell: cmd
          
        - name: Deploy  
          run: ${{ env.DBB_Host }} ${{ env.UCD_Deploy }} General-Insurance DEV https://9.76.61.223:8443 GeneralsBackendComponent:latest Deploy
          shell: cmd 
          
                    
#        - name: Deploy to Dev
#          run: | 
#                $uri = 'https://9.76.61.223:8443/cli/applicationProcessRequest/request'
#                [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
#                Invoke-RestMethod -Method 'Put' -Uri $uri -Body '{
#                    "application":"General-Insurance",
#                    "applicationProcess":"Deploy",
#                    "environment":"DEV",
#                      "versions":[{
#                        "version":"latest",
#                        "component":"GeneralsBackendComponent" 
#                      }]
#                }' -UseBasicParsing -Headers @{"Authorization" = "Basic $( [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes("admin:admin")))"} 
#
#
#
